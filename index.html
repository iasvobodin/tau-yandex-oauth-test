<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Загрузка на общий диск</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 15px;
    margin: 0;
    background: #fafafa;
    color: #333;
  }

  h2 {
    font-size: 1.2rem;
    margin-bottom: 15px;
    text-align: center;
  }

  #controls {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;
  }

  button {
    padding: 10px 16px;
    cursor: pointer;
    border: none;
    border-radius: 6px;
    background: #4a90e2;
    color: white;
    font-size: 0.9rem;
    flex: 1 1 auto;
    max-width: 220px;
  }

  button:hover {
    background: #357abd;
  }

  #preview {
    display: grid;
    gap: 12px;
    margin-top: 10px;
  }

  .thumb {
    display: flex;
    align-items: center;
    gap: 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 8px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .thumb img {
    width: 120px;
    height: auto;
    border-radius: 4px;
    flex-shrink: 0;
  }

  .file-info {
    flex: 1;
    font-size: 0.9rem;
  }

  .status {
    font-size: 0.9rem;
    font-weight: bold;
    min-width: 100px;
    text-align: right;
  }

  .status.waiting { color: #888; }
  .status.uploading { color: #e69500; }
  .status.success { color: #2d9d2d; }
  .status.error { color: #d93025; }

  #output {
    background: #f4f4f4;
    padding: 10px;
    overflow-x: auto;
    font-size: 0.8rem;
    white-space: pre-wrap;
    border-radius: 6px;
    margin-top: 20px;
  }

  @media (max-width: 600px) {
    h2 {
      font-size: 1rem;
    }
    button {
      font-size: 0.8rem;
      padding: 8px 12px;
    }
    .thumb {
      flex-direction: column;
      align-items: flex-start;
    }
    .status {
      text-align: left;
    }
  }
</style>
</head>
<body>

<h2 id="info">Вы загружаете фотографии на общий диск</h2>

<div id="controls">
  <input type="file" id="fileInput"  accept="image/*,video/*"  multiple capture="environment" style="display:none"/>
  <button id="selectBtn">Выбрать фотографии</button>
  <button id="uploadBtn">Загрузить выбранные фото</button>
</div>

<div id="preview"></div>

<pre id="output"></pre>

<script>
  const CLIENT_ID = "e6e17b4cbbb6476d940403b2b1057da2"; 
  const REDIRECT_URI = window.location.origin + window.location.pathname;
  let filesToUpload = [];

  let urlParams = new URLSearchParams(window.location.search);
  let folderName = urlParams.get('folder') || 'Фото';
  let subfolderName = urlParams.get('subfolder') || 'Новая папка';

  const hash = new URLSearchParams(window.location.hash.substring(1));
  let accessToken = hash.get("access_token");

  if (!accessToken) {
    const state = encodeURIComponent(JSON.stringify({ folder: folderName, subfolder: subfolderName }));
    const authUrl = `https://oauth.yandex.ru/authorize?response_type=token&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=cloud_api:disk.read cloud_api:disk.write&state=${state}`;
    window.location.href = authUrl;
  } else {
    let stateData = {};
    try {
      stateData = JSON.parse(decodeURIComponent(hash.get('state') || '{}'));
    } catch(e){}
    folderName = stateData.folder || folderName;
    subfolderName = stateData.subfolder || subfolderName;

    document.getElementById("info").textContent = `Вы загружаете файлы в папку "${folderName}" под именем "${subfolderName}-***"`;

    const output = document.getElementById("output");
    function log(msg) { output.textContent += msg + "\n"; }

    log("Авторизация успешна. Access token получен.");

    const fileInput = document.getElementById("fileInput");
    document.getElementById("selectBtn").onclick = () => fileInput.click();

    fileInput.onchange = (event) => {
      filesToUpload = Array.from(event.target.files);
      const previewDiv = document.getElementById("preview");
      previewDiv.innerHTML = "";
      filesToUpload.forEach(file => {
        const div = document.createElement("div");
        div.className = "thumb";

        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);

        const infoDiv = document.createElement("div");
        infoDiv.className = "file-info";
        infoDiv.textContent = file.name;

        const statusDiv = document.createElement("div");
        statusDiv.className = "status waiting";
        statusDiv.textContent = "⏳ Ожидает";

        div.appendChild(img);
        div.appendChild(infoDiv);
        div.appendChild(statusDiv);
        previewDiv.appendChild(div);

        file._statusEl = statusDiv; // сохраним ссылку
      });
    };

    async function ensureFolderExists(path) {
      const encodedPath = encodeURIComponent(path);
      try {
        const res = await fetch(`https://cloud-api.yandex.net/v1/disk/resources?path=${encodedPath}`, {
          method: "GET",
          headers: { Authorization: `OAuth ${accessToken}` }
        });
        if (res.status === 404) {
          log(`Папка "${path}" не найдена. Создаём...`);
          const createRes = await fetch(`https://cloud-api.yandex.net/v1/disk/resources?path=${encodedPath}`, {
            method: "PUT",
            headers: { Authorization: `OAuth ${accessToken}` }
          });
          if (!createRes.ok) throw new Error(`Ошибка создания папки: ${createRes.status}`);
          log(`Папка "${path}" успешно создана.`);
        } else {
          log(`Папка "${path}" уже существует.`);
        }
      } catch (err) {
        log(`Ошибка при проверке/создании папки "${path}": ${err.message}`);
        throw err;
      }
    }

    document.getElementById("uploadBtn").onclick = async () => {
      const baseFolder = `Системы ТАУ - Общее/Фото ТАУ контроль/${folderName}`;

      try {
        await ensureFolderExists(baseFolder);
      } catch(e) {
        log("Не удалось подготовить папку. Загрузка отменена.");
        return;
      }

      const encodedBaseFolder = encodeURIComponent(baseFolder);

      function getRandomSuffix(length = 3) {
        const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
        let result = "";
        for (let i = 0; i < length; i++) {
          result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
      }

      for (let file of filesToUpload) {
        try {
          file._statusEl.className = "status uploading";
          file._statusEl.textContent = "⬆ Загрузка...";

          // берём расширение файла
          const ext = file.name.includes(".") ? file.name.substring(file.name.lastIndexOf(".")) : "";
          const newFileName = `${subfolderName}__${getRandomSuffix()}${ext}`;

          const uploadRes = await fetch(`https://cloud-api.yandex.net/v1/disk/resources/upload?path=${encodedBaseFolder}/${encodeURIComponent(newFileName)}&overwrite=true`, {
            method: "GET",
            headers: { Authorization: `OAuth ${accessToken}` }
          });
          const uploadData = await uploadRes.json();
          if (!uploadData.href) throw new Error("Не удалось получить ссылку для загрузки");

          const putRes = await fetch(uploadData.href, { method: "PUT", body: file });
          if (!putRes.ok) throw new Error("Ошибка загрузки файла");

          log(`Файл "${file.name}" сохранён как "${newFileName}" в "${folderName}".`);
          file._statusEl.className = "status success";
          file._statusEl.textContent = "✅ Загружено";
        } catch (err) {
          log(`Ошибка при загрузке "${file.name}": ${err.message}`);
          file._statusEl.className = "status error";
          file._statusEl.textContent = "❌ Ошибка";
        }
      }

      filesToUpload = [];
      fileInput.value = "";
    };
  }
</script>
</body>
</html>
