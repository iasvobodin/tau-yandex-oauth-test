<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Загрузка фото на Яндекс.Диск</title>
</head>
<body>
  <h2>Загрузка фото на Яндекс.Диск</h2>
  <pre id="output"></pre>
  <input type="file" id="fileInput" multiple style="display:none"/>
  <button id="uploadBtn" style="display:none">Выбрать фотографии</button>

  <script>
    const CLIENT_ID = "4bc4d55d82f4403fa49256dc971508fd"; // вставь сюда client_id от Яндекс OAuth
    const REDIRECT_URI = window.location.origin + window.location.pathname;

    // Начало OAuth авторизации
    function startAuth() {
      const authUrl = `https://oauth.yandex.ru/authorize?response_type=token&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
      window.location.href = authUrl;
    }

    // Выводим сообщения в output
    function log(msg) {
      const output = document.getElementById("output");
      output.textContent += msg + "\n";
    }

    // Загрузка файла на Яндекс.Диск
    async function uploadFile(token, file) {
      try {
        // 1. Получаем ссылку для загрузки
        const res1 = await fetch(`https://cloud-api.yandex.net/v1/disk/resources/upload?path=${encodeURIComponent(file.name)}&overwrite=true`, {
          method: "GET",
          headers: { Authorization: `OAuth ${token}` }
        });
        const data1 = await res1.json();
        if (!data1.href) throw new Error("Не удалось получить ссылку для загрузки");

        // 2. Загружаем файл
        const res2 = await fetch(data1.href, {
          method: "PUT",
          body: file
        });
        if (!res2.ok) throw new Error("Ошибка загрузки файла");

        // 3. Получаем публичную ссылку
        const res3 = await fetch(`https://cloud-api.yandex.net/v1/disk/resources/publish?path=${encodeURIComponent(file.name)}`, {
          method: "PUT",
          headers: { Authorization: `OAuth ${token}` }
        });
        const data3 = await res3.json();

        // 4. Формируем прямую ссылку
        const link = `https://yadi.sk/d/${data3.path.split('/').pop()}`;
        log(`Файл "${file.name}" загружен. Ссылка: ${link}`);
      } catch (err) {
        log(`Ошибка: ${err.message}`);
      }
    }

    // Проверяем, есть ли токен в URL
    const hash = new URLSearchParams(window.location.hash.substring(1));
    if (hash.has("access_token")) {
      const token = hash.get("access_token");
      log("access_token: " + token);

      // Показываем кнопку и input
      document.getElementById("uploadBtn").style.display = "inline-block";
      document.getElementById("fileInput").style.display = "inline-block";

      document.getElementById("uploadBtn").onclick = () => {
        document.getElementById("fileInput").click();
      };

      document.getElementById("fileInput").onchange = async (event) => {
        const files = event.target.files;
        for (let file of files) {
          await uploadFile(token, file);
        }
      };

    } else {
      // Если токена нет, сразу редиректим на авторизацию
      startAuth();
    }
  </script>
</body>
</html>
