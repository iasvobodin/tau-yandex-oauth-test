<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Загрузка на общий диск</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 15px;
    margin: 0;
    background: #fafafa;
    color: #333;
  }

  h2 {
    font-size: 1.2rem;
    margin-bottom: 15px;
    text-align: center;
  }

  #controls {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;
  }

  button {
    padding: 10px 16px;
    cursor: pointer;
    border: none;
    border-radius: 6px;
    background: #4a90e2;
    color: white;
    font-size: 0.9rem;
    flex: 1 1 auto;
    max-width: 220px;
  }

  button:hover {
    background: #357abd;
  }

  #preview {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    margin-top: 10px;
  }

  .thumb {
    display: grid;
    grid-template-columns: 100px 1fr 30px;
    align-items: center;
    gap: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 5px 10px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .thumb img {
    max-width: 90px;
    max-height: 90px;
    border-radius: 4px;
  }

  .thumb p {
    font-size: 0.8rem;
    margin: 0 0 4px 0;
    word-break: break-word;
  }

  .progress {
    width: 100%;
    height: 6px;
    background: #eee;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 4px;
  }

  .progress-bar {
    height: 100%;
    width: 0%;
    background: #4a90e2;
    transition: width 0.2s;
  }

  .status {
    font-size: 1.2rem;
    color: #ccc;
  }
  .status.success {
    color: green;
  }
  .status.error {
    color: red;
  }

  #output {
    background: #f4f4f4;
    padding: 10px;
    overflow-x: auto;
    font-size: 0.8rem;
    white-space: pre-wrap;
    border-radius: 6px;
    margin-top: 20px;
  }

  @media (max-width: 600px) {
    h2 {
      font-size: 1rem;
    }
    button {
      font-size: 0.8rem;
      padding: 8px 12px;
    }
    .thumb {
      grid-template-columns: 70px 1fr 30px;
    }
    .thumb img {
      max-width: 60px;
      max-height: 60px;
    }
  }
</style>
</head>
<body>

<h2 id="info">Вы загружаете фотографии на общий диск</h2>

<div id="controls">
  <input type="file" id="fileInput" accept="image/*,video/*" multiple capture="environment" style="display:none"/>
  <button id="selectBtn">Выбрать фотографии</button>
  <button id="uploadBtn">Загрузить выбранные фото</button>
</div>

<div id="preview"></div>

<pre id="output"></pre>

<script>
  const CLIENT_ID = "e6e17b4cbbb6476d940403b2b1057da2";
  const REDIRECT_URI = window.location.origin + window.location.pathname;
  let filesToUpload = [];

  // сначала читаем параметры из query (если они были до редиректа)
  let urlParams = new URLSearchParams(window.location.search);
  let folderName = urlParams.get('folder') || 'Фото';
  let subfolderName = urlParams.get('subfolder') || 'Новая папка';

  // читаем хэш (куда OAuth вернёт access_token и state)
  const hash = new URLSearchParams(window.location.hash.substring(1));
  const accessTokenFromHash = hash.get("access_token");

  // если токен пришёл через URL (редирект OAuth), то:
  if (accessTokenFromHash) {
    // состояние может быть в state (мы туда передавали folder/subfolder)
    let stateData = {};
    try {
      stateData = JSON.parse(decodeURIComponent(hash.get('state') || '{}'));
    } catch (e) {
      // ignore
    }

    // восстановим folder/subfolder из state (если там есть), иначе используем уже прочитанные из query
    folderName = stateData.folder || folderName;
    subfolderName = stateData.subfolder || subfolderName;

    // сохраняем токен в sessionStorage
    sessionStorage.setItem("yandex_token", accessTokenFromHash);

    // восстановим параметры в адресной строке (чтобы ?folder=...&subfolder=... остались видны)
    const newSearch = new URLSearchParams(window.location.search);
    newSearch.set('folder', folderName);
    newSearch.set('subfolder', subfolderName);

    history.replaceState(null, "", window.location.pathname + "?" + newSearch.toString());
    // теперь hash (с access_token) удалён из адресной строки и folder/subfolder в query
  }

  // достаём токен из sessionStorage
  let accessToken = sessionStorage.getItem("yandex_token");

  // если токена нет — направляем на OAuth
  if (!accessToken) {
    const state = encodeURIComponent(JSON.stringify({ folder: folderName, subfolder: subfolderName }));
    const authUrl = `https://oauth.yandex.ru/authorize?response_type=token&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=cloud_api:disk.read cloud_api:disk.write&state=${state}`;
    window.location.href = authUrl;
  }

  // ---- UI ----
  document.getElementById("info").textContent = `Вы загружаете фотографии в папку "${folderName}"`;

  const output = document.getElementById("output");
  function log(msg) { output.textContent += msg + "\n"; }

  log("Авторизация успешна. Access token получен.");

  const fileInput = document.getElementById("fileInput");
  document.getElementById("selectBtn").onclick = () => fileInput.click();

  fileInput.onchange = (event) => {
    filesToUpload = Array.from(event.target.files);
    const previewDiv = document.getElementById("preview");
    previewDiv.innerHTML = "";
    filesToUpload.forEach((file, idx) => {
      const div = document.createElement("div");
      div.className = "thumb";
      div.dataset.index = idx;

      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);

      const infoDiv = document.createElement("div");
      const p = document.createElement("p");
      p.textContent = file.name;
      const progress = document.createElement("div");
      progress.className = "progress";
      const bar = document.createElement("div");
      bar.className = "progress-bar";
      progress.appendChild(bar);
      infoDiv.appendChild(p);
      infoDiv.appendChild(progress);

      const status = document.createElement("div");
      status.className = "status";
      status.textContent = "…";

      div.appendChild(img);
      div.appendChild(infoDiv);
      div.appendChild(status);

      previewDiv.appendChild(div);
    });
  };

  async function ensureFolderExists(path) {
    const encodedPath = encodeURIComponent(path);
    try {
      const res = await fetch(`https://cloud-api.yandex.net/v1/disk/resources?path=${encodedPath}`, {
        method: "GET",
        headers: { Authorization: `OAuth ${accessToken}` }
      });
      if (res.status === 404) {
        log(`Папка "${path}" не найдена. Создаём...`);
        const createRes = await fetch(`https://cloud-api.yandex.net/v1/disk/resources?path=${encodedPath}`, {
          method: "PUT",
          headers: { Authorization: `OAuth ${accessToken}` }
        });
        if (!createRes.ok) throw new Error(`Ошибка создания папки: ${createRes.status}`);
        log(`Папка "${path}" успешно создана.`);
      }
    } catch (err) {
      log(`Ошибка при проверке/создании папки "${path}": ${err.message}`);
      throw err;
    }
  }

  document.getElementById("uploadBtn").onclick = async () => {
    if (!filesToUpload.length) return;

    const baseFolder = `Системы ТАУ - Общее/Фото ТАУ контроль/${folderName}`;

    try {
      await ensureFolderExists(baseFolder);
    } catch(e) {
      log("Не удалось подготовить папку. Загрузка отменена.");
      return;
    }

    for (let i = 0; i < filesToUpload.length; i++) {
      const file = filesToUpload[i];
      const ext = file.name.includes(".") ? file.name.substring(file.name.lastIndexOf(".")) : "";
      const randomSuffix = Math.random().toString(36).substring(2, 5);
      const newFileName = `${subfolderName}-${randomSuffix}${ext}`;

      const encodedPath = encodeURIComponent(`${baseFolder}/${newFileName}`);

      const thumb = document.querySelector(`.thumb[data-index="${i}"]`);
      const bar = thumb.querySelector(".progress-bar");
      const status = thumb.querySelector(".status");

      try {
        const uploadRes = await fetch(`https://cloud-api.yandex.net/v1/disk/resources/upload?path=${encodedPath}&overwrite=true`, {
          method: "GET",
          headers: { Authorization: `OAuth ${accessToken}` }
        });
        const uploadData = await uploadRes.json();
        if (!uploadData.href) throw new Error("Не удалось получить ссылку для загрузки");

        // Загружаем файл с прогрессом
        await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open("PUT", uploadData.href, true);
          xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
              const percent = (e.loaded / e.total) * 100;
              bar.style.width = percent + "%";
            }
          };
          xhr.onload = () => xhr.status === 201 || xhr.status === 200 ? resolve() : reject(new Error("Ошибка загрузки"));
          xhr.onerror = () => reject(new Error("Ошибка сети"));
          xhr.send(file);
        });

        status.textContent = "✓";
        status.classList.add("success");
        log(`Файл "${newFileName}" успешно загружен.`);

      } catch (err) {
        status.textContent = "✗";
        status.classList.add("error");
        log(`Ошибка при загрузке "${file.name}": ${err.message}`);
      }
    }

    filesToUpload = [];
    fileInput.value = "";
  };
</script>
</body>
</html>
